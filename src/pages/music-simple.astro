---
import { site } from "@/constants";
import { getFormatDate } from "@/lib/utils";
import {
  Link,
  PlayIcon,
  RepeatIcon,
  CheckIcon,
  HeartIcon,
  Image,
  NoListenIcon,
  LayoutDefault,
} from "@/components";
import PlayNow from "@/components/atoms/playnow.svelte";
import { getLastfmData } from "@/lib/music";

const { tracks, artists, albums } = await getLastfmData();
---

<LayoutDefault type="main">
  <div class="border-divider border-b-[1px]">
    <h1>{site.pages.music.title}</h1>
    <p>
      {site.pages.music.description}
    </p>
  </div>

  <section class="space-y-4">
    <PlayNow client:load
      >\
      <svelte:fragment slot="play">
        Escuchando ahora <PlayIcon className="inline-flex size-4" />
      </svelte:fragment>
      <svelte:fragment slot="noplay">
        Última reproducción <NoListenIcon className="inline-flex size-4" />
      </svelte:fragment>
    </PlayNow>
  </section>

  <section class="space-y-4">
    <h2>
      Escuchado recientemente <CheckIcon className="inline-flex size-4" />
    </h2>
    <ul class="space-y-2">
      {
        tracks.map(({ date, name, artist, url }) => (
          <li class="list-none">
            <Link href={url} className="flex items-baseline" blank>
              {date && (
                <time
                  class="text-muted min-w-20 text-sm whitespace-nowrap"
                  datetime={getFormatDate(
                    new Date(Number.parseInt(date.uts) * 1000),
                  )}
                >
                  {getFormatDate(
                    new Date(Number.parseInt(date.uts) * 1000),
                    "es-ES",
                    {
                      year: "numeric",
                      month: "2-digit",
                    },
                  )
                    .split("/")
                    .reverse()
                    .join(" · ")}
                </time>
              )}
              <u class="gap-1 font-medium sm:flex sm:items-center">
                <span class="line-clamp-1 max-w-2xs">{name}</span>
                <span class="text-muted line-clamp-1 text-sm">
                  <span class="hidden text-base sm:inline-flex">{" · "}</span>
                  {artist["#text"]}
                </span>
              </u>
            </Link>
          </li>
        ))
      }
    </ul>
  </section>

  <section>
    <h2>En bucle últimamente <RepeatIcon className="inline-flex size-5" /></h2>
    <ul class="space-y-2">
      {
        artists.map(({ name, url, playcount }) => (
          <li class="list-none">
            <Link
              href={url}
              blank
              className="flex items-baseline justify-between gap-4"
            >
              <span class="line-clamp-1 w-full font-medium">{name}</span>
              <span class="text-muted inline-block min-w-16 text-right text-sm">
                {playcount} rep.
              </span>
            </Link>
          </li>
        ))
      }
    </ul>
  </section>

  <section>
    <h2>Obsesionado con <HeartIcon className="inline-flex size-4" /></h2>
    <ul class="grid grid-cols-2 gap-4 [@media(min-width:480px)]:grid-cols-4">
      {
        albums.map(({ image, name, url, artist: { name: artistName } }) => {
          const imageUrl = image.find((img) => img.size === "large")?.["#text"];
          return (
            <li class="list-none">
              <Link href={url} blank>
                <div class="border-divider overflow-hidden rounded-md border-[1px]">
                  <Image src={imageUrl} alt={name} />
                </div>
                <div class="mt-1 space-y-0">
                  <p class="line-clamp-1 text-sm leading-snug font-medium text-pretty">
                    {name}
                  </p>
                  <p class="text-muted m-0 text-xs">{artistName}</p>
                </div>
              </Link>
            </li>
          );
        })
      }
    </ul>
  </section>
</LayoutDefault>
