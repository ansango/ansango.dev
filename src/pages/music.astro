---
import { LayoutDefault } from "@/layout";
import { userApiMethods } from "@/lib/lastfm/services";
import { site } from "@/constants";
import { getFormatDate } from "@/lib/utils";
import {
  Link,
  PlayIcon,
  RepeatIcon,
  CheckIcon,
  HeartIcon,
  Image,
} from "@/components";

import PlayNow from "@/components/playnow/playnow.svelte";
import { getLastfmData } from "@/lib/music";

const { tracks, artists, albums } = await getLastfmData();
---

<LayoutDefault type="main">
  <div class="border-divider border-b-[1px]">
    <h1>{site.pages.music.title}</h1>
    <p>
      {site.pages.music.description}
    </p>
  </div>

  <section class="space-y-4">
    <h2>Escuchando ahora <PlayIcon className="inline-flex size-4" /></h2>
    <PlayNow client:load />
  </section>

  <section class="space-y-4">
    <h2>
      Escuchado recientemente <CheckIcon className="inline-flex size-4" />
    </h2>
    <ul class="space-y-2">
      {
        tracks.map(({ date, name, artist }) => (
          <li class="list-none">
            <Link
              href={`https://www.last.fm/music/${artist["#text"]}/_/${name}`}
              className="flex items-baseline"
              blank
            >
              {date && (
                <time
                  class="text-muted min-w-20 text-sm whitespace-nowrap"
                  datetime={getFormatDate(
                    new Date(Number.parseInt(date.uts) * 1000),
                  )}
                >
                  {getFormatDate(
                    new Date(Number.parseInt(date.uts) * 1000),
                    "es-ES",
                    {
                      year: "numeric",
                      month: "2-digit",
                    },
                  )
                    .split("/")
                    .reverse()
                    .join(" · ")}
                </time>
              )}
              <u class="gap-1 font-medium sm:flex sm:items-center">
                <span class="line-clamp-1 max-w-2xs">{name}</span>
                <span class="text-muted line-clamp-1 text-sm">
                  <span class="hidden text-base sm:inline-flex">{" · "}</span>
                  {artist["#text"]}
                </span>
              </u>
            </Link>
          </li>
        ))
      }
    </ul>
  </section>

  <section>
    <h2>En bucle últimamente <RepeatIcon className="inline-flex size-5" /></h2>
    <ul class="space-y-2">
      {
        artists.map((artist) => (
          <li class="list-none">
            <Link
              href={`https://www.last.fm/music/${artist.name}`}
              blank
              className="flex items-baseline justify-between gap-4"
            >
              <span class="line-clamp-1 w-full font-medium">{artist.name}</span>
              <span class="text-muted inline-block min-w-16 text-right text-sm">
                {artist.playcount} rep.
              </span>
            </Link>
          </li>
        ))
      }
    </ul>
  </section>

  <section>
    <h2>Obsesionado con <HeartIcon className="inline-flex size-4" /></h2>
    <ul class="grid grid-cols-2 gap-4 [@media(min-width:480px)]:grid-cols-4">
      {
        albums.map((album) => {
          const imageUrl = album.image.find((img) => img.size === "large")?.[
            "#text"
          ];
          return (
            <li class="list-none">
              <Link
                href={`https://www.last.fm/music/${album.artist.name}/${album.name}`}
                blank
              >
                <div class="border-divider overflow-hidden rounded-md border-[1px]">
                  <Image src={imageUrl} alt={album.name} />
                </div>
                <div class="space-y-0">
                  <p class="line-clamp-1 text-sm leading-snug font-medium text-pretty">
                    {album.name}
                  </p>
                  <p class="text-muted m-0 text-xs">{album.artist.name}</p>
                </div>
              </Link>
            </li>
          );
        })
      }
    </ul>
  </section>
</LayoutDefault>
