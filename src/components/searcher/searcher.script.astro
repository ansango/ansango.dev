<script lang="ts" is:inline>
  const searcher = () => {
    const searchButton = document.getElementById("searcher-button");
    const dialog = document.getElementById("searcher-dialog");
    const dialogFrame = document.getElementById("searcher-dialog-frame");

    if (!searchButton || !dialog || !dialogFrame) return;

    if (dialog._initialized) return;
    dialog._initialized = true;

    const customizeClearButton = () => {
      const clearButton = document.querySelector(".pagefind-ui__search-clear");
      if (clearButton && !clearButton._customized) {
        clearButton._customized = true;
        clearButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="size-4" width="18" height="18" viewBox="0 0 24 24">
            <path fill="currentColor" d="M6.225 4.811a1 1 0 0 0-1.414 1.414L10.586 12L4.81 17.775a1 1 0 1 0 1.414 1.414L12 13.414l5.775 5.775a1 1 0 0 0 1.414-1.414L13.414 12l5.775-5.775a1 1 0 0 0-1.414-1.414L12 10.586z"/>
          </svg>`;
      }
    };

    // Observar cambios en el DOM para detectar cuando Pagefind añade el botón
    const observer = new MutationObserver(() => {
      customizeClearButton();
    });

    observer.observe(dialogFrame, {
      childList: true,
      subtree: true,
    });

    // Intentar personalizar inmediatamente por si ya existe
    customizeClearButton();

    const openDialog = () => {
      if (document.body.contains(dialog)) {
        dialog.showModal();
        document.body.classList.add("overflow-hidden");
      }
    };

    const closeDialog = () => {
      if (document.body.contains(dialog)) {
        dialog.close();
        document.body.classList.remove("overflow-hidden");
      }
    };

    searchButton.addEventListener("click", (event) => {
      event.stopPropagation();
      openDialog();
    });

    window.addEventListener("click", (event) => {
      if (
        document.body.contains(dialog) &&
        document.body.contains(event.target) &&
        !dialogFrame.contains(event.target)
      ) {
        closeDialog();
      }
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        e.preventDefault();
        closeDialog();
      }
      if (e.key === "/") {
        e.preventDefault();
        openDialog();
      }
    });
  };

  document.addEventListener("astro:page-load", searcher);
  document.addEventListener("astro:after-swap", searcher);
</script>
