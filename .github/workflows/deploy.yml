name: ansango.com
env:
  TEMPLATE_REPO: ansango/ansango.dev
  CONTENT_DIR: sites/ansango.com/content
  ASSETS_DIR: system/assets

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "sites/ansango.com/content/**"
  schedule:
    - cron: "0 9 */2 * *" # Every 2 days at 9 AM UTC

# Cancel in-progress runs if new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ==========================================
      # CHECKOUT REPOSITORIES
      # ==========================================
      
      - name: ðŸ“¥ Checkout content repository
        uses: actions/checkout@v4
        with:
          path: temp_md
          
      - name: ðŸ“¥ Checkout blog template
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TEMPLATE_REPO }}
          token: ${{ secrets.PAT }}
          path: template_blog
      
      # ==========================================
      # PREPARE CONTENT FOR CONVERSION
      # ==========================================
          
      - name: ðŸ“ Prepare content and assets for export
        run: |
          mkdir -p temp_md/publish
          cp -r temp_md/${{ env.CONTENT_DIR }} temp_md/publish
          cp -r temp_md/${{ env.ASSETS_DIR }} temp_md/publish
      
      # ==========================================
      # OBSIDIAN TO MARKDOWN CONVERSION
      # ==========================================
          
      - name: ðŸ’¾ Cache obsidian-export binary
        uses: actions/cache@v4
        id: obsidian-cache
        with:
          path: obsidian-export_Linux-x86_64.bin
          key: obsidian-export-v22.11.0
          
      - name: ðŸ“¥ Download obsidian-export
        if: steps.obsidian-cache.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/zoni/obsidian-export/releases/download/v22.11.0/obsidian-export_Linux-x86_64.bin
          chmod +x obsidian-export_Linux-x86_64.bin
          
      - name: ðŸ”„ Convert Obsidian to Markdown
        run: |
          find template_blog/src/content -mindepth 1 -maxdepth 1 -type d -exec rm -rf {} \;
          ./obsidian-export_Linux-x86_64.bin ./temp_md/publish template_blog/src
          
      - name: ðŸ“¦ Move converted files to working directory
        run: |
          cp -r template_blog/. .
          rm -rf template_blog
          rm -rf temp_md
      
      # ==========================================
      # BUILD SITE
      # ==========================================
          
      - name: ðŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 'latest'
          
      - name: ðŸ’¾ Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-
            
      - name: ðŸ”¨ Build site
        env:
          # API credentials
          RAINDROP_ACCESS_TOKEN: ${{ secrets.RAINDROP_ACCESS_TOKEN }}
          LASTFM_SHARED_SECRET: ${{ secrets.LASTFM_SHARED_SECRET }}
          
          # Public environment variables
          PUBLIC_LASTFM_API_KEY: ${{ secrets.PUBLIC_LASTFM_API_KEY }}
          PUBLIC_LASTFM_APPNAME: ansango.dev
          PUBLIC_LASTFM_API_BASE_URL: https://ws.audioscrobbler.com/2.0
          PUBLIC_GOATCOUNTER_CODE: ${{ secrets.PUBLIC_GOATCOUNTER_CODE }}
        run: bun install && bun run build
      
      # ==========================================
      # DEPLOY TO CLOUDFLARE PAGES
      # ==========================================
        
      - name: ðŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=ansango-dev --commit-dirty=true
      
      # ==========================================
      # NOTIFICATIONS
      # ==========================================
          
      - name: ðŸ“Š Build summary (success)
        if: success()
        run: |
          echo "### âœ… Deployment Successful! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ’¬ Build summary (failure)
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "**Failed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
